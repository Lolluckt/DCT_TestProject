<Page x:Class="CryptoTrackerApp.Views.MainView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Title="MainView">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,10">
            <TextBox Width="200" Margin="0,0,10,0" VerticalAlignment="Center"
               Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" />
            <Button Content="Search" Command="{Binding SearchCurrenciesCommand}" VerticalAlignment="Center" />
            <TextBlock Text=" Sort by:" Margin="20,0,5,0" VerticalAlignment="Center"/>
            <ComboBox Width="120" Margin="0,0,10,0" VerticalAlignment="Center"
                ItemsSource="{Binding SortOptions}"
                SelectedValue="{Binding SelectedSortOption}"
                SelectionChanged="ComboBox_SelectionChanged">
            </ComboBox>
            <Button Content="Clear" Command="{Binding ClearSearchCommand}" VerticalAlignment="Center"/>
            <Button Content="Reload Top 10" Command="{Binding LoadTopCurrenciesCommand}" Margin="20,0,0,0" VerticalAlignment="Center"/>
        </StackPanel>

        <Grid Grid.Row="1" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Text="{Binding StatusMessage}" Grid.Column="0" VerticalAlignment="Center" />
            <ProgressBar IsIndeterminate="True" Width="100" Height="10" Grid.Column="1"
                         Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
        </Grid>

        <ListView Grid.Row="2" ItemsSource="{Binding CurrenciesView}" SelectedItem="{Binding SelectedCurrency}"
              MouseLeftButtonUp="ListView_MouseLeftButtonUp">
            <ListView.View>
                <GridView>
                    <GridViewColumn Header="Name" DisplayMemberBinding="{Binding Name}" Width="200">
                        <GridViewColumn.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" MouseLeftButtonDown="Header_MouseLeftButtonDown" Tag="Name">
                                    <TextBlock Text="{Binding}" />
                                    <Path Margin="5,0,0,0" VerticalAlignment="Center" Width="8" Height="8" 
                                          Visibility="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Name}"
                                          Data="M 0,8 L 8,8 L 4,0 Z" Fill="Black" 
                                          RenderTransformOrigin="0.5,0.5">
                                        <Path.Style>
                                            <Style TargetType="Path">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Name">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Price">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="MarketCap">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                        <Path.RenderTransform>
                                            <RotateTransform Angle="{Binding DataContext.IsAscendingSort, RelativeSource={RelativeSource AncestorType=ListView}, Converter={StaticResource BoolToRotationConverter}}" />
                                        </Path.RenderTransform>
                                    </Path>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.HeaderTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Symbol" DisplayMemberBinding="{Binding Symbol}" Width="100"/>
                    <GridViewColumn Header="Price (USD)" Width="120">
                        <GridViewColumn.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" MouseLeftButtonDown="Header_MouseLeftButtonDown" Tag="Price">
                                    <TextBlock Text="{Binding}" />
                                    <Path Margin="5,0,0,0" VerticalAlignment="Center" Width="8" Height="8"
                                          Data="M 0,8 L 8,8 L 4,0 Z" Fill="Black"
                                          RenderTransformOrigin="0.5,0.5">
                                        <Path.Style>
                                            <Style TargetType="Path">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Price">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Name">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="MarketCap">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                        <Path.RenderTransform>
                                            <RotateTransform Angle="{Binding DataContext.IsAscendingSort, RelativeSource={RelativeSource AncestorType=ListView}, Converter={StaticResource BoolToRotationConverter}}" />
                                        </Path.RenderTransform>
                                    </Path>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.HeaderTemplate>
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding CurrentPrice, StringFormat={}{0:C2}}" HorizontalAlignment="Right" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Market Cap" Width="150">
                        <GridViewColumn.HeaderTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" MouseLeftButtonDown="Header_MouseLeftButtonDown" Tag="MarketCap">
                                    <TextBlock Text="{Binding}" />
                                    <Path Margin="5,0,0,0" VerticalAlignment="Center" Width="8" Height="8"
                                          Data="M 0,8 L 8,8 L 4,0 Z" Fill="Black"
                                          RenderTransformOrigin="0.5,0.5">
                                        <Path.Style>
                                            <Style TargetType="Path">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="MarketCap">
                                                        <Setter Property="Visibility" Value="Visible" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Name">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding DataContext.SelectedSortOption, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Price">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                        <Path.RenderTransform>
                                            <RotateTransform Angle="{Binding DataContext.IsAscendingSort, RelativeSource={RelativeSource AncestorType=ListView}, Converter={StaticResource BoolToRotationConverter}}" />
                                        </Path.RenderTransform>
                                    </Path>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.HeaderTemplate>
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding MarketCap, StringFormat={}{0:N0}}" HorizontalAlignment="Right" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="24h Change (%)" Width="120">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding PriceChangePercentage24h, StringFormat={}{0:+0.##%;-0.##%;0.##%}}"
                           Foreground="{Binding PriceChangePercentage24h, Converter={StaticResource PercentageColorConverter}}"
                           HorizontalAlignment="Right"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                </GridView>
            </ListView.View>
        </ListView>
    </Grid>
</Page>